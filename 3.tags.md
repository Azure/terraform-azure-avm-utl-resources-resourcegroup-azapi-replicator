# Task #3: tags - Implementation Proof

## Summary
The `tags` argument is a root-level optional parameter that maps Terraform map(string) to Azure's tags at the resource root level (not in body). Implementation includes exact validation replication (max 50 tags, key max 512 chars, value max 256 chars) and is updatable (not ForceNew).

## Provider Schema

From `resourceResourceGroup()`:
```go
Schema: map[string]*pluginsdk.Schema{
    "tags": commonschema.Tags(),
}
```

From `commonschema.Tags()`:
```go
func Tags() *schema.Schema {
	return &schema.Schema{
		Type:         schema.TypeMap,
		Optional:     true,
		ValidateFunc: tags.Validate,
		Elem: &schema.Schema{
			Type: schema.TypeString,
		},
	}
}
```

**Field Properties:**
- Type: `map[string]string`
- Required: No (Optional)
- ForceNew: No (updatable)
- Computed: No
- Sensitive: No
- ValidateFunc: `tags.Validate`

## Validation Logic

From `tags.Validate()`:
```go
func Validate(v interface{}, _ string) (warnings []string, errors []error) {
	tagsMap := v.(map[string]interface{})

	if len(tagsMap) > 50 {
		errors = append(errors, fmt.Errorf("a maximum of 50 tags can be applied to each resource"))
	}

	for k, v := range tagsMap {
		if len(k) > 512 {
			errors = append(errors, fmt.Errorf("the maximum length for a tag key is 512 characters: %q is %d characters", k, len(k)))
		}

		value, err := tagValueToString(v)
		if err != nil {
			errors = append(errors, err)
		} else if len(value) > 256 {
			errors = append(errors, fmt.Errorf("the maximum length for a tag value is 256 characters: the value for %q is %d characters", k, len(value)))
		}
	}

	return warnings, errors
}
```

**Validation Rules Replicated:**
1. Maximum 50 tags allowed
2. Tag key maximum length: 512 characters
3. Tag value maximum length: 256 characters

## Create Phase Verification

From `resourceResourceGroupCreate()`:
```go
parameters := resourcegroups.ResourceGroup{
    Location: location.Normalize(d.Get("location").(string)),
    Tags:     tags.Expand(d.Get("tags").(map[string]interface{})),  // <-- Tags set in Create phase
}

if v := d.Get("managed_by").(string); v != "" {
    parameters.ManagedBy = pointer.To(v)
}

if _, err := client.CreateOrUpdate(ctx, id, parameters); err != nil {
    return fmt.Errorf("creating %q: %+v", id, err)
}
```

**Pattern**: Single-phase create operation
- Tags are set during the primary `CreateOrUpdate` call
- No post-creation operations for tags
- Decision: Implement in `local.azapi_header.tags` (root-level parameter)

## Assignment Path Verification

### Predicted Path
`tags` → root-level parameter in `azapi_resource`

### Go Code Evidence
From Create method:
```go
parameters := resourcegroups.ResourceGroup{
    Location: location.Normalize(d.Get("location").(string)),
    Tags:     tags.Expand(d.Get("tags").(map[string]interface{})),
}
```

The `tags.Expand()` function:
```go
func Expand(input map[string]interface{}) *map[string]string {
	output := make(map[string]string)

	for k, v := range input {
		tagKey := k
		tagValue := v.(string)
		output[tagKey] = tagValue
	}

	return &output
}
```

**Assignment**: `parameters.Tags` receives the pointer to map[string]string

### Verified Path
`tags` → **root-level** in azapi_resource (not in body)

### Path Comparison
✅ **MATCH** - `tags` is a root-level parameter in both AzureRM ResourceGroup struct and azapi_resource schema.

## Azure API Schema

Query for `Microsoft.Resources/resourceGroups@2023-07-01`:
```
tags: Map(String)
```

From Azure API documentation:
```
"A mapping of tags which should be assigned to the Azure resource."
```

**Confirmed**: `tags` is a root-level property in the Azure API, not nested under `properties` or `body`.

## Mapping

| AzureRM Field | Azure API Field | AzAPI Location | Type |
|---------------|-----------------|----------------|------|
| `tags` | `tags` | `local.azapi_header.tags` | `map[string]string` |

## Update Behavior

From `resourceResourceGroupUpdate()`:
```go
patch := resourcegroups.ResourceGroupPatchable{}

if d.HasChange("managed_by") {
    patch.ManagedBy = pointer.To(d.Get("managed_by").(string))
}

if d.HasChange("tags") {
    patch.Tags = tags.Expand(d.Get("tags").(map[string]interface{}))
}

if _, err := client.Update(ctx, *id, patch); err != nil {
    return fmt.Errorf("updating %q: %+v", *id, err)
}
```

**Behavior**: Tags can be updated in-place without replacement. No ForceNew logic.

## Special Handling

### ForceNew: No
Tags are fully updatable. No entry in `replace_triggers_external_values`.

### Validation: Yes
Implemented in `variables.tf`:
```hcl
variable "tags" {
  type        = map(string)
  default     = null
  description = "(Optional) A mapping of tags which should be assigned to the Resource Group."

  validation {
    condition     = var.tags == null || length(var.tags) <= 50
    error_message = "A maximum of 50 tags can be applied to each resource."
  }

  validation {
    condition = var.tags == null || alltrue([
      for k, v in var.tags : length(k) <= 512
    ])
    error_message = "The maximum length for a tag key is 512 characters."
  }

  validation {
    condition = var.tags == null || alltrue([
      for k, v in var.tags : length(v) <= 256
    ])
    error_message = "The maximum length for a tag value is 256 characters."
  }
}
```

### Sensitive: No
Tags are not marked as sensitive in the provider schema.

### Implementation Location
Already correctly placed in `migrate_main.tf`:
```hcl
locals {
  azapi_header = {
    type                  = "Microsoft.Resources/resourceGroups@2023-07-01"
    name                  = var.name
    location              = var.location
    parent_id             = var.subscription_id
    tags                  = var.tags
    ignore_null_property  = true
    retry                 = null
  }
}
```

## Hidden Fields

No hidden fields related to tags. The `tags.Expand()` function performs a straightforward conversion from `map[string]interface{}` to `*map[string]string`.

## Edge Case Analysis

### Null Tags
- **Provider behavior**: When `tags` is `null`, `tags.Expand()` receives an empty map and returns a pointer to empty map
- **Implementation**: `var.tags` can be `null`, passed directly to `azapi_header.tags`
- **Result**: Correct behavior - null tags are handled properly

### Empty Map
- **Provider behavior**: Empty map `{}` is valid, returns pointer to empty map
- **Implementation**: Empty map passes validation (0 tags ≤ 50)
- **Result**: Correct behavior

### Tag Key/Value Boundaries
- **Provider validation**: 
  - Max 50 tags
  - Key max 512 characters
  - Value max 256 characters
- **Implementation**: All three validations replicated exactly
- **Result**: Correct behavior - fails fast at plan time

### Idempotency
- **Provider behavior**: Map is converted consistently, order doesn't matter
- **Implementation**: Terraform map type is inherently unordered
- **Result**: Idempotent

### Safe References
- **Implementation**: `var.tags` is used directly, no nested access
- **Result**: Safe - no null dereference risk

## Deferred Work Completion

Checked `following.md` - file does not exist, no deferred work for this task.

## Checklist

- ✅ Property in correct local (`azapi_header.tags`)
- ✅ ForceNew wrapped: N/A (not ForceNew)
- ✅ All logic exactly replicated from provider (validation rules)
- ✅ Validations implemented in variables.tf (3 validation blocks)
- ✅ TODO comment: N/A (not a sensitive field)
- ✅ Hidden fields checked: None
- ✅ Deferred work in following.md: N/A
- ✅ Deferred work from following.md: None found
- ✅ Critical review completed
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Self-Review: Only added validation for tags, no other fields touched

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-23
**Task:** #3 - tags

### Validation Results

✅ **ForceNew Logic:** Not applicable - tags are updatable, no ForceNew logic required
✅ **Stable Keys:** Not applicable - no replace_triggers_external_values entries for updatable field
✅ **Phase Detection:** Correctly identified as Create phase field, implemented in `local.azapi_header.tags`
✅ **Type Conversion:** Correct direct mapping from Terraform `map(string)` to Azure API `tags`
✅ **Null Handling:** Correctly allows null (optional field with default = null)
✅ **Validations:** All three provider validations exactly replicated in variables.tf:
  - Maximum 50 tags validation
  - Tag key maximum 512 characters validation
  - Tag value maximum 256 characters validation
✅ **Root-Level Placement:** Correctly placed in `azapi_header.tags` (root-level azapi_resource parameter, not in body)
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed:
  - Null tags handling
  - Empty map handling
  - Tag key/value boundary conditions
  - Idempotency verified
  - Safe references confirmed

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. All validation rules from the provider's `tags.Validate()` function were replicated precisely in variables.tf. The tags field is correctly placed in the root-level azapi_header structure (not in body), matching the Azure Resource Manager API schema. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
